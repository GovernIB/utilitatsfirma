package es.caib.utilitatsfirma.api.interna.all.exemplepublic;

import java.util.Locale;

import javax.validation.constraints.Pattern;
import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;

import org.apache.log4j.Logger;
import org.fundaciobit.genapp.common.i18n.I18NCommonUtils;
import org.fundaciobit.genapp.common.i18n.I18NException;
import es.caib.utilitatsfirma.commons.utils.Version;

import org.fundaciobit.pluginsib.utils.rest.RestException;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.info.Contact;
import io.swagger.v3.oas.annotations.info.Info;
import io.swagger.v3.oas.annotations.info.License;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.ExternalDocumentation;
import io.swagger.v3.oas.annotations.OpenAPIDefinition;
import io.swagger.v3.oas.annotations.tags.Tag;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.media.Content;

/**
 *  Exemple de Servei JSON d'accés Públic
 */
@Path("/public/exemplepublic")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
@OpenAPIDefinition(
        tags = @Tag(name = "ExemplePublicService", description = "Exemple de Servei JSON d'accés Públic"),
        info = @Info(
                title = "API REST INTERNA de UtilitatsFirma - Exemple de Servei Públic",
                description = "Conjunt de Serveis REST de UtilitatsFirma per ser accedits públicament",
                version = "1.0-SNAPSHOT",
                license = @License(
                        name = "European Union Public Licence (EUPL v1.2)",
                        url = "https://joinup.ec.europa.eu/sites/default/files/custom-page/attachment/eupl_v1.2_es.pdf"),
                contact = @Contact(
                        name = "Departament de Govern Digital a la Fundació Bit",
                        email = "otae@fundaciobit.org",
                        url = "https://governdigital.fundaciobit.org")

        ),
        externalDocs = @ExternalDocumentation(
                description = "Java Client (GovernIB Github)",
                url = "https://github.com/GovernIB/utilitatsfirma/tree/utilitatsfirma-1.0/utilitatsfirma-api-interna-client-exemplepublic-v1"))
public class ExemplePublicService {

    protected final Logger log = Logger.getLogger(ExemplePublicService.class);

    public static final String TAG_NAME = "Versio";

    @Path("/versio")
    @GET
    @Produces(MediaType.APPLICATION_JSON)
    @Consumes(MediaType.APPLICATION_JSON)
    @Operation(
            tags = TAG_NAME,
            operationId = "versio",
            summary = "Versio de l'Aplicació",
            method = "get")
    @ApiResponses(
            value = {
                    @ApiResponse(
                            responseCode = "400",
                            description = "Paràmetres incorrectes",
                            content = @Content(mediaType = MediaType.APPLICATION_JSON)),
                    @ApiResponse(
                            responseCode = "200",
                            description = "Versió i idioma",
                            content = @Content(
                                    mediaType = MediaType.APPLICATION_JSON,
                                    schema = @Schema(implementation = ExemplePojo.class))) })
    public ExemplePojo versio(

            @Parameter(
                    description = "Codi de l'idioma",
                    required = false,
                    examples = { @io.swagger.v3.oas.annotations.media.ExampleObject(name = "Català", value = "ca"),
                                 @io.swagger.v3.oas.annotations.media.ExampleObject(name = "Castellano", value = "es")},
                    schema = @Schema(implementation = String.class)) 
                                @Pattern(regexp = "^ca|es$") @QueryParam("idioma") String idioma) throws RestException {

        try {
            ExemplePojo exemple = new ExemplePojo(new Version().getVersion() + "_" + idioma);

            return exemple;

        } catch (Throwable th) {

            String msg;
            if (th instanceof I18NException) {
                I18NException ie = (I18NException) th;
                msg = I18NCommonUtils.getMessage(ie, new Locale(idioma));
            } else {
                msg = th.getMessage();
            }

            log.error("Error cridada api rest 'versio': " + msg, th);

            throw new RestException(msg);

        }
    }

}
